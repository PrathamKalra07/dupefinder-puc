<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chunked Upload</title>
</head>
<body>
  <h2>Upload Large File</h2>
  <input type="file" id="fileInput" />
  <button id="uploadBtn">Upload</button>
  <pre id="status"></pre>

  <script>
    const status = document.getElementById("status");
    const CHUNK_SIZE = 5 * 1024 * 1024; 

    document.getElementById("uploadBtn").addEventListener("click", async () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Select a file first");

      const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
      status.textContent = `Uploading ${file.name} in ${totalChunks} chunks...\n`;

      for (let i = 0; i < totalChunks; i++) {
        const start = i * CHUNK_SIZE;
        const end = Math.min(file.size, start + CHUNK_SIZE);
        const chunk = file.slice(start, end);

        const formData = new FormData();
        formData.append("chunk", chunk);
        formData.append("fileName", file.name);
        formData.append("chunkIndex", i);
        formData.append("totalChunks", totalChunks);

        try {
          const res = await fetch("/api/upload-chunk", {
            method: "POST",
            body: formData,
          });
          if (!res.ok) throw new Error(res.statusText);
          status.textContent += `Chunk ${i + 1}/${totalChunks} uploaded\n`;
        } catch (err) {
          status.textContent += `Error uploading chunk ${i + 1}: ${err.message}\n`;
          return;
        }
      }

      try {
        const mergeRes = await fetch("/api/merge-chunks", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fileName: file.name, totalChunks }),
        });

        if (!mergeRes.ok) throw new Error(mergeRes.statusText);
        const data = await mergeRes.json();
        status.textContent += `\nUpload complete! ${data.message}`;
      } catch (err) {
        status.textContent += `\nMerge failed: ${err.message}`;
      }
    });
  </script>
</body>
</html>
